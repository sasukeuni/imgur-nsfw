#!/usr/bin/env python
import yaml, platform
from ImgurNSFW import ImgurNSFW
from sys import exit
from os import system, mkdir, environ
from os.path import isdir

# Import the config; set the API key, gallery and type.
nsfw   = ImgurNSFW()
config = yaml.load(open(nsfw.getScriptPath() + '/config.yml', 'r'))
nsfw.setKey(config['key'])
nsfw.setGallery(config['gallery'])
nsfw.setType(config['type'])

# Get a wallpaper.
wallpaper = nsfw.getWallpaper()
if wallpaper == False:
    exit()

# Check if we have a wallpaper directory.
if not isdir(nsfw.getScriptPath() + '/wallpapers'):
    mkdir(nsfw.getScriptPath() + '/wallpapers')

# Save the wallpaper and get it's local path.
wallpaper_path = nsfw.saveWallpaper(wallpaper)

environment = config['environment']
if environment == 'gnome':
    # GNOME Shell commands.
    system('DISPLAY=:0 GSETTINGS_BACKEND=dconf gsettings set org.gnome.desktop.background picture-uri file://' + wallpaper_path)
    system('DISPLAY=:0 GSETTINGS_BACKEND=dconf gsettings set org.gnome.desktop.background picture-options zoom')
elif environment == 'xfce':
    # XFCE commands.
    system('DISPLAY=:0 xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/image-path -s ' + wallpaper_path)
elif environment == 'mac':
    # Mac OSX commands.
    script = """/usr/bin/osascript<<END
tell application "Finder"
set desktop picture to POSIX file "%s"
end tell
END"""
    system(script % wallpaper_path)